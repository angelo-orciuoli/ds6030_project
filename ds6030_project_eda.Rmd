---
title: "DS6030 Project Part 1: Exploratory Data Analysis"
output: html_document
---

```{r}
library(tidyverse)
library(tidymodels)
library(GGally)
library(ggplot2)
library(knitr)
library(kableExtra)
library(discrim)
library(dplyr) 
library(yardstick)
library(patchwork)
```


```{r}
train_data <- read.csv("train/HaitiPixels.csv")
head(train_data)
```

<span style="font-size: 20px;"><strong>Original Variable Definitions</strong></span>

<div style="font-size: 14px;">

**Class:** A categorical variable representing the true label for each data point (i.e., what is seen in the aerial image).

• "Vegetation" – likely areas with trees, grass, or plants  
• "Soil" – likely bare earth or dirt  
• "Rooftop" – man-made structures such as buildings  
• "Various Non-Tarp" – miscellaneous surfaces not relevant to identifying displaced persons  
• "Blue Tarp" – the positive class we're trying to detect. These blue tarps likely indicate makeshift shelters created by displaced persons  

**Red, Green, Blue:** Numeric variables ranging from 0 to 255, representing the intensity of each color channel (RGB) in an image.

• 0 represents no intensity (dark) and 255 represents full intensity (pure color)  
• Example: Red = 48, Green = 50, Blue = 230 would appear predominantly blue, possibly indicating a blue tarp  
• Example: Red = 180, Green = 160, Blue = 90 would appear brownish, potentially representing soil or rooftop  

</div>

```{r}
# Feature Engineering: color ratios
train_data <- train_data %>%
  mutate(
    Blue_Red_Ratio = Blue / Red,
    Blue_Green_Ratio = Blue / Green,
    Green_Red_Ratio = Green / Red,
    Blue_Dominance = Blue / (Red + Green + Blue),  # Blue's share of total color
    Color_Purity = pmax(Red, Green, Blue) / (Red + Green + Blue), # How pure is the dominant color
    Brightness = Red + Green + Blue
  )
head(train_data)
```

**New Variables**

- **Blue_Red_Ratio: Measures how much blue dominates over red. If value > 1, then blue is stronger than red; if < 1, then red dominates**
- **Blue_Green_Ratio: Measures blue dominance over green. If value > 1, then blue is stronger than green; if < 1, then green dominates**
- **Green_Red_Ratio: Measures green dominance over red. If value > 1, then green is stronger than red; if < 1, then red dominates**
- **Blue_Dominance: Blue's share of total color**
- **Color_Purity: The dominant color's share of the total color**
- **Brightness: Total illumination level across all color channels (Red + Green + Blue); higher values indicate brighter/lighter pixels while lower values indicate darker pixels, regardless of color**

Reason: These variables allow us to explore how the relationships of the colors correlate to the classes instead of exploring colors independently of each other.

```{r}
#| fig.width: 10
#| fig.height: 5
# Number and proportion of images in each class
class_summary <- train_data %>%
  count(Class) %>%
  mutate(
    Percentage = round(100 * n / sum(n), 1),
    FillColor = ifelse(Class == "Blue Tarp", "blue", "#384860")
  )

ggplot(class_summary, aes(x = Class, y = n, fill = FillColor)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = paste0(n, " (", Percentage, "%)")), vjust = -0.5) +
  scale_fill_identity() + 
  theme_minimal() +
  theme(axis.text.x = element_text(size = 12)) + 
  labs(title = "Class Distribution", y = "Count", x = NULL)
```



```{r}
#| fig.width: 12
#| fig.height: 6
# Boxplots
red_bxplt <- ggplot(train_data, aes(x = Class, y = Red)) +
  geom_boxplot(fill = "red") +
  labs(title = "Red Channel Intensity by Class", x = NULL, y = NULL) +
  theme_minimal() +
  theme(axis.text.x = element_text(size = 12, angle = 45, hjust = 1))

green_bxplt <- ggplot(train_data, aes(x = Class, y = Green)) +
  geom_boxplot(fill = "green") +
  labs(title = "Green Channel Intensity by Class", x = NULL, y = NULL) +
  theme_minimal() +
  theme(axis.text.x = element_text(size = 12, angle = 45, hjust = 1))

blue_bxplt <- ggplot(train_data, aes(x = Class, y = Blue)) +
  geom_boxplot(fill = "blue") +
  labs(title = "Blue Channel Intensity by Class", x = NULL, y = NULL) +
  theme_minimal() +
  theme(axis.text.x = element_text(size = 12, angle = 45, hjust = 1))

red_bxplt + green_bxplt + blue_bxplt
```

```{r}
# Medians
median_table <- train_data %>%
  group_by(Class) %>%
  summarise(
    red = median(Red),
    green = median(Green),
    blue = median(Blue)
  ) %>%
  pivot_longer(cols = c(red, green, blue), names_to = "Color", values_to = "Median") %>%
  pivot_wider(names_from = Class, values_from = Median)

kable(median_table, caption = "Median RGB Intensities by Class") %>%
kable_styling(full_width = FALSE, position = "center")
```

This chart below might not be necessary. Maybe something that could just be in the report.

```{r}
# Function to find the count of the most frequent color intensity value
# (i.e., the peak height of the color distribution) for each class

max_counts <- sapply(c("Red", "Green", "Blue"), function(color) {
  sapply(unique(train_data$Class), function(cls) {
    max(hist(train_data[[color]][train_data$Class == cls],
             breaks = seq(0, 255, by = 5), plot = FALSE)$counts)
  })
})

# Distributions
rgb_dist <- function(data, class_name) {
  
  class_data <- data %>% filter(Class == class_name)
  max_y <- max(max_counts[class_name, ]) # Ensure alignment of axes
  
  red_dist <- ggplot(class_data, aes(x = Red)) +
    geom_area(stat = "bin", binwidth = 6, fill = "red", alpha = 1) +
    theme_minimal() +
    labs(x = "Red Channel Intensity", y = "Image Count") +
    coord_cartesian(xlim = c(0, 255), ylim = c(0, max_y))

  green_dist <- ggplot(class_data, aes(x = Green)) +
    geom_area(stat = "bin", binwidth = 6, fill = "green", alpha = 1) +
    theme_minimal() +
    labs(x = "Green Channel Intensity", y = "Image Count") +
    coord_cartesian(xlim = c(0, 255), ylim = c(0, max_y))

  blue_dist <- ggplot(class_data, aes(x = Blue)) +
    geom_area(stat = "bin", binwidth = 6, fill = "blue", alpha = 1) +
    theme_minimal() +
    labs(x = "Blue Channel Intensity", y = "Image Count") +
    coord_cartesian(xlim = c(0, 255), ylim = c(0, max_y))

  (red_dist + green_dist + blue_dist) +
    plot_annotation(title = paste("Color Breakdown of", class_name, "Images")) +
    theme(plot.title = element_text(size = 20, hjust = 0.5))
}
```

```{r}
#| fig.width: 11
#| fig.height: 5
rgb_dist(train_data, "Blue Tarp")
rgb_dist(train_data, "Vegetation")
rgb_dist(train_data, "Rooftop")
rgb_dist(train_data, "Various Non-Tarp")
rgb_dist(train_data, "Soil")
```

```{r}
# Calculate blue tarp statistics for decision boundaries
blue_tarp_stats <- train_data %>%
  filter(Class == "Blue Tarp") %>%
  summarise(
    mean_br = mean(Blue_Red_Ratio), # Average Blue/Red ratio across blue tarp images
    mean_bg = mean(Blue_Green_Ratio), # Average Blue/Green ratio across blue tarp images
    q25_br = quantile(Blue_Red_Ratio, 0.25), # Bottom quartile of Blue/Red Ratio
    q25_bg = quantile(Blue_Green_Ratio, 0.25) # Bottom quartile of Blue/Green Ratio
  )

# Blue/Red vs Blue/Green Ratio Scatter Plot
color_ratio <- ggplot(train_data, aes(x = Blue_Red_Ratio, y = Blue_Green_Ratio)) +
  geom_point(aes(color = Class), alpha = 0.6, size = 0.8) +
  # Add potential decision boundaries
  geom_vline(xintercept = blue_tarp_stats$q25_br, linetype = "dashed", color = "red", alpha = 0.7) +
  geom_hline(yintercept = blue_tarp_stats$q25_bg, linetype = "dashed", color = "red", alpha = 0.7) +
  scale_color_manual(values = c("Blue Tarp" = "blue", 
                               "Vegetation" = "green", 
                               "Soil" = "brown", 
                               "Rooftop" = "black", 
                               "Various Non-Tarp" = "orange")) +
  theme_minimal() +
  labs(title = "Potential Blue Tarp Decision Boundaries",
       subtitle = "Dashed lines show 25th percentile thresholds for blue tarps",
       x = "Blue/Red Ratio", 
       y = "Blue/Green Ratio") +
  theme(legend.position = "right",
        legend.title = element_blank())

color_ratio +
  guides(color = guide_legend(override.aes = list(size = 2)))
```
- **75% of blue tarp images have a Blue/Red ratio greater than 1.094237 (to the right of the vertical dashed line)**
- **75% of blue tarp images have a Blue/Green ration greater than 1.025158 (above the horizontal dashed line)**


> Page break. Above is training data. Below is holdout data.
> 


# Blue Tarp Holdout Data

```{r}
col_names <- c("ID", "X", "Y", "Map_X", "Map_Y", "Lat", "Lon", "B1", "B2", "B3")

# orthovnir067 Blue Tarp data
holdout067_blue <- read.delim("holdout/orthovnir067_ROI_Blue_Tarps.txt", 
                               skip = 8, header = FALSE, sep = "", col.names = col_names)

# orthovnir069 Blue Tarp data
holdout069_blue <- read.delim("holdout/orthovnir069_ROI_Blue_Tarps.txt", 
                               skip = 8, header = FALSE, sep = "", col.names = col_names)

# orthovnir078 Blue Tarp data
holdout078_blue <- read.delim("holdout/orthovnir078_ROI_Blue_Tarps.txt", 
                               skip = 8, header = FALSE, sep = "", col.names = col_names)
```


# Non-Blue Tarp Holdout Data

```{r}
# orthovnir057 NON-Blue Tarp data
holdout057_nonblue <- read.delim("holdout/orthovnir057_ROI_NON_Blue_Tarps.txt", 
                               skip = 8, header = FALSE, sep = "", col.names = col_names)

# orthovnir067 NOT-Blue Tarp data
holdout067_nonblue <- read.delim("holdout/orthovnir067_ROI_NOT_Blue_Tarps.txt", 
                               skip = 8, header = FALSE, sep = "", col.names = col_names)

# orthovnir069 NOT-Blue Tarp data
holdout069_nonblue <- read.delim("holdout/orthovnir069_ROI_NOT_Blue_Tarps.txt", 
                               skip = 8, header = FALSE, sep = "", col.names = col_names)

# orthovnir078 NON-Blue Tarp data
holdout078_nonblue <- read.delim("holdout/orthovnir078_ROI_NON_Blue_Tarps.txt", 
                               skip = 8, header = FALSE, sep = "", col.names = col_names)
```

```{r}
# Should be 3,991,823 and not 979,728. Missing almost 2 million rows. Right? Idk.
tail(holdout078_nonblue)
```

